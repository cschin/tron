<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">

<html lang="en">
<script src="https://unpkg.com/htmx.org@1.9.11"
  integrity="sha384-0gxUXCCR8yv9FM2b+U3FDbsKthCI66oH5IA9fHppQq9DDMHuMauqq1ZHBpJxQ0J0" crossorigin="anonymous"></script>
<script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/json-enc.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/multi-swap.js"></script>

<body>
  <div hx-get="/load_page" hx-swap="outerHTML" hx-trigger="load">Loading Page</div>
  </form>
  <script>
    window.addEventListener("load", (event) => {
      console.log("page is fully loaded");
      // Create a new EventSource instance pointing to the endpoint where your server sends the events
      const eventSource = new EventSource('/server_events');

      // Listen for messages from the server
      eventSource.onmessage = function (event) {
        const event_data = JSON.parse(event.data);
        const state = event_data["server_side_trigger"]["new_state"]; 
        const target = event_data["server_side_trigger"]["target"]; 
        console.log('New message from server:', event.data, target, state);
        document.getElementById(target).setAttribute("state", state);
        htmx.trigger("#"+target, "server_side_trigger", {});
      };

      // Listen for errors
      eventSource.onerror = function (event) {
        // Handle errors here
        console.error('EventSource failed:', event);
      };

      // To close the connection when it's no longer needed
      // eventSource.close();
    });



  </script>

</html>