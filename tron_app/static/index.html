<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.tailwindcss.com"></script>

<html lang="en">
<script src="https://unpkg.com/htmx.org@1.9.11"
  integrity="sha384-0gxUXCCR8yv9FM2b+U3FDbsKthCI66oH5IA9fHppQq9DDMHuMauqq1ZHBpJxQ0J0" crossorigin="anonymous"></script>
<script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/json-enc.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/multi-swap.js"></script>

<body>
  <div hx-get="/load_page" hx-swap="outerHTML" hx-trigger="load">Loading Page</div>
  </form>
  <script>
    window.addEventListener("load", (event) => {
      console.log("page is fully loaded");
      // Create a new EventSource instance pointing to the endpoint where your server sends the events
      const eventSource = new EventSource('/server_events');

      // Listen for messages from the server
      eventSource.onmessage = function (event) {
        const event_data = JSON.parse(event.data);
        const state = event_data["server_side_trigger"]["new_state"];
        const target = event_data["server_side_trigger"]["target"];
        if ("start_recording_audio" in event_data) {
          recording_audio("#" + target);
        };
        if ("stop_recording_audio" in event_data) {
          stop_recording();
        }
        console.log('New message from server:', event.data, target, state);
        document.getElementById(target).setAttribute("state", state);
        htmx.trigger("#" + target, "server_side_trigger", {});
      };

      // Listen for errors
      eventSource.onerror = function (event) {
        // Handle errors here
        console.error('EventSource failed:', event);
      };

      // To close the connection when it's no longer needed
      // eventSource.close();
    });

    // for input element, the value is stored in the attribute
    function get_input_event(event) {
      return {
        "tn_event":
        {
          "e_target": event.currentTarget.id,
          "e_type": event.type,
          "e_state": event.currentTarget.getAttribute('state')
        },
        "e_value": document.getElementById(event.currentTarget.id).value
      };
    };

    function get_event(event) {
      return {
        "tn_event":
        {
          "e_target": event.currentTarget.id,
          "e_type": event.type,
          "e_state": event.currentTarget.getAttribute('state')
        }
      };
    };

    // for non-input element, the value is stored in innerHTML
    function get_event_with_value(event) {
      return {
        "tn_event":
        {
          "e_target": event.currentTarget.id,
          "e_type": event.type,
          "e_state": event.currentTarget.getAttribute('state')
        },
        "e_value": document.getElementById(event.currentTarget.id).innerHTML
      };
    };

    const blobToBase64 = blob => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        return new Promise(resolve => {
            reader.onloadend = () => {
            resolve(reader.result);
            };
        });
    };

    let mediaRecorder;

    function recording_audio(element_id) {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = event => {
            blobToBase64(event.data).then(encoded_chunk =>
              htmx.trigger(element_id, "streaming", { audio_data: encoded_chunk, streaming: true })
            );
          };
          mediaRecorder.onstop = () => {
            setTimeout(() => htmx.trigger(element_id, "streaming", { streaming: false }), 1000);
          };
          mediaRecorder.start(1000);
        })
        .catch(err => {
          console.error("An error occurred:", err);
          alert("An error occurred while trying to access the microphone. Please check microphone permissions.");
        });
    }

    function stop_recording() {
      if (mediaRecorder) {
        mediaRecorder.stop();
      }
    }

  </script>
</html>