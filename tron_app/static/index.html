<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.tailwindcss.com"></script>

<html lang="en">
<script src="https://unpkg.com/htmx.org@1.9.11"
  integrity="sha384-0gxUXCCR8yv9FM2b+U3FDbsKthCI66oH5IA9fHppQq9DDMHuMauqq1ZHBpJxQ0J0" crossorigin="anonymous"></script>
<script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/json-enc.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/multi-swap.js"></script>
<script>
  window.process_special_events = { "empty": () => { } }
</script>

<body>
  <div hx-get="/load_page" hx-swap="outerHTML" hx-trigger="load">Loading Page</div>
</body>

<script>
  window.addEventListener("load", (event) => {
    console.log("page is fully loaded");
    // Create a new EventSource instance pointing to the endpoint where your server sends the events
    window.eventSource = new EventSource('/server_events');

    // Listen for messages from the server
    window.eventSource.onmessage = function (event) {
      const event_data = JSON.parse(event.data);
      const state = event_data["server_side_trigger"]["new_state"];
      const target = event_data["server_side_trigger"]["target"];
      for (const key in window.process_special_events ) {
        if (window.process_special_events.hasOwnProperty(key)) {
          window.process_special_events[key](target, state, event_data)
        }
      }

      console.log('New message from server:', event.data, target, state);
      document.getElementById(target).setAttribute("state", state);
      htmx.trigger("#" + target, "server_side_trigger", {});
    };

    // Listen for errors
    window.eventSource.onerror = function (event) {
      // Handle errors here
      console.error('EventSource failed:', event);
    };
  })

  window.addEventListener("beforeunload", (event) => {
    console.log("page is fully loaded");
    eventSource.close();
  })

  // standard event response functions
  // for input element, the value is stored in the attribute
  function get_input_event(event) {
    return {
      "tn_event":
      {
        "e_target": event.currentTarget.id,
        "e_type": event.type,
        "e_state": event.currentTarget.getAttribute('state')
      },
      "e_value": document.getElementById(event.currentTarget.id).value
    };
  };

  function get_event(event) {
    return {
      "tn_event":
      {
        "e_target": event.currentTarget.id,
        "e_type": event.type,
        "e_state": event.currentTarget.getAttribute('state')
      }
    };
  };

  // for non-input element, the value is stored in innerHTML
  function get_event_with_value(event) {
    return {
      "tn_event":
      {
        "e_target": event.currentTarget.id,
        "e_type": event.type,
        "e_state": event.currentTarget.getAttribute('state')
      },
      "e_value": document.getElementById(event.currentTarget.id).innerHTML
    };
  };
</script>

</html>